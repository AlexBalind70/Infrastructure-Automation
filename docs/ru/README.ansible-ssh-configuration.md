# SSH Security Hardening

Данный модуль настраивает базовую защиту SSH на серверах.

Цели:
- уменьшить поверхность атаки
- ограничить доступ по SSH
- выявлять несанкционированные входы
- защититься от брутфорс-атак

Вся конфигурация применяется автоматически через Ansible.

---

## Что настраивается

### Контроль доступа по SSH
- Доступ по SSH ограничен белым списком IP-адресов
- Подключение разрешено только с указанных IP

### Уведомления о входе по SSH
- При успешном входе по SSH отправляется уведомление в Telegram
- Позволяет отслеживать, кто и когда заходил на сервер

### Fail2Ban
- Защищает SSH от брутфорс-атак
- Блокирует IP после нескольких неудачных попыток входа
- Работает как дополнительный уровень защиты

### Уведомления Fail2Ban
- Уведомления в Telegram о блокировках IP (опционально)
- По умолчанию отключены

---

## Важные рекомендации по безопасности

### Отключение входа по паролю (рекомендуется)
Для важных серверов:
- отключить вход по SSH с использованием пароля
- разрешить доступ **только по SSH-ключам**

Причина:
> Чем больше способов входа разрешено, тем больше векторов атаки существует.

На практике вход по паролю должен быть отключён
на всех production и критически важных серверах.

---

### Порт SSH
- Стандартный порт SSH (22) активно сканируется
- Использование нестандартного порта снижает количество автоматических атак

Это **не замена безопасности**, а способ снизить «шум».

---

### Уведомления Fail2Ban (практический опыт)

Уведомления Fail2Ban о блокировках **по умолчанию отключены**.

Причины:
- брутфорс SSH происходит постоянно
- уведомления быстро становятся навязчивыми
- возникает усталость от алертов

Рекомендации:
- включать уведомления о блокировках только для отладки или на короткое время
- всегда оставлять включёнными уведомления о входах

---

## Логирование

- Логи SSH включены и сохраняются
- Логи Fail2Ban доступны для аудита
- Логи можно использовать для анализа инцидентов

---

## Конфигурационные файлы

В модуле используются шаблоны конфигураций:

- [sshd_config.example](../../src/ansible-ssh-configuration/ssh/sshd_config.example) — конфигурация SSH-демона  
- [ssh.conf.example](../../src/ansible-ssh-configuration/ssh/fail2ban/jail.d/ssh.conf.example) — правила Fail2Ban для SSH  
- [ssh-notify.sh.example](../../src/ansible-ssh-configuration/ssh/ssh-notify.sh.example) — уведомления о входе в Telegram  
- [telegram-ban.conf.example](../../src/ansible-ssh-configuration/ssh/fail2ban/telegram-ban.conf.example) — интеграция Fail2Ban с Telegram  


Все файлы являются шаблонами и применяются через Ansible.

---

## Как это работает

1. Усиливается конфигурация SSH
2. Доступ ограничивается разрешёнными IP
3. Fail2Ban отслеживает ошибки аутентификации
4. Telegram-уведомления отправляются при:
   - успешных входах по SSH
   - блокировках IP (опционально)

---

## Инструкция запуска

### Как запустить

1. В файле `hosts` добавь целевые серверы в группу `ssh_configuration`, на которые будет применена SSH-конфигурация
2. Перед запуском убедись, что указаны токен Telegram-бота, ID чата и ID топика в файлах  
   ([ssh-notify.sh.example](../../src/ansible-ssh-configuration/ssh/ssh-notify.sh.example),  
   [ssh.conf.example](../../src/ansible-ssh-configuration/ssh/fail2ban/jail.d/ssh.conf.example))
3. Запусти:

```bash
make ssh-conf-setup
```

Ручные изменения конфигурации на серверах не рекомендуются.


### Принципы проектирования
- Минимально возможная поверхность атаки
- Явный контроль доступа
- Видимость действий вместо «тихих» отказов
- Безопасный повторный запуск (idempotent)











